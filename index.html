<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fa-solid fa-bus"></i> | Autobusy Szczecin</span>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>


    <!-- Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Ustawienia mapy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Przyciski wyboru typu mapy -->
                    <div>
                        <label>
                            <input type="radio" name="mapType" value="thunderforest"> Thunderforest
                        </label>
                        <label>
                            <input type="radio" name="mapType" value="osm" checked> OpenStreetMap
                        </label>
                    </div>
                    <br>
                    <!-- Pole wprowadzania klucza API -->
                    <div>
                        <label for="apiKey">Klucz API:</label>
                        <input type="text" id="apiKey">
                        <button onclick="saveApiKey()">Zapisz</button>
                    </div>
                    <br><br>
                    <div>Ta aplikacja zapewnia śledzenie na żywo autobusów i tramwajów w Szczecinie.<br><br>Dla więcej informacji lub aby przyczynić się, odwiedź: <br> <a href="https://github.com/Alexshch09/autobusy" target="_blank">https://github.com/Alexshch09/autobusy</a></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>
    
    
    <div style="height: 92vh;">
        <div id="map" style="height: 100%;"></div>
    </div>

    <script>
        var mapType = getSavedMapType() || "osm";
        var apiKey = getSavedApiKey();
        // if (apiKey) {
        //     document.getElementById('apiKeySection').style.display = 'none';
        // }

        // Initialize Leaflet map
        var map = L.map('map').setView([53.441, 14.563360], 18);

        var tileLayer;
        changeTileLayer(mapType);

        function changeTileLayer(mapType) {
            if (mapType === "thunderforest") {
                if (!apiKey) {
                    alert("Please provide an API key. You can get one from Thunderforest website.");
                    return;
                }
                tileLayer = L.tileLayer('https://a.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=' + apiKey, {
                    maxZoom: 19,
                });
            } else if (mapType === "osm") {
                tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                });
            }

            map.eachLayer(function (layer) {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });

            tileLayer.addTo(map);
            document.querySelector('input[name="mapType"][value="' + mapType + '"]').checked = true;
        }

        // Function to fetch vehicle data from the API
        async function fetchVehicleData() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/vehicles');
                const data = await response.json();
                return data.data; // Return only the 'data' array from the response
            } catch (error) {
                console.error('Error fetching vehicle data:', error);
                return [];
            }
        }

        // Function to save API key in a cookie
        function saveApiKey() {
            apiKey = document.getElementById("apiKey").value;
            document.cookie = "apiKey=" + apiKey + "; expires=Infinity";
        }

        // Function to get saved API key from cookie
        function getSavedApiKey() {
            const cookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("apiKey="));
            if (cookie) {
                return cookie.split("=")[1];
            }
            return null;
        }

        // Function to save map type in a cookie
        function saveMapType(mapType) {
            document.cookie = "mapType=" + mapType + "; expires=Infinity";
        }

        // Function to get saved map type from cookie
        function getSavedMapType() {
            const cookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("mapType="));
            if (cookie) {
                return cookie.split("=")[1];
            }
            return null;
        }

        // Add event listener to radio buttons to change map type
        document.querySelectorAll('input[name="mapType"]').forEach(input => {
            input.addEventListener("change", function () {
                mapType = this.value;
                saveMapType(mapType);
                changeTileLayer(mapType);
            });
        });

        // Function to add markers for vehicles to the map
        async function addVehicleMarkers() {
            const vehicleData = await fetchVehicleData();
            if (vehicleData) {
                // Clear previous vehicle markers from the map
                vehicleMarkers.clearLayers();

                vehicleData.forEach(vehicle => {
                    var customIcon;
                    if (vehicle.vehicle_type === "bus") {
                        customIcon = L.divIcon({
                            className: 'bus-icon',
                            html: `<div>${vehicle.line_number}</div>`
                        });
                    } else if (vehicle.vehicle_type === "tram") {
                        customIcon = L.divIcon({
                            className: 'tram-icon',
                            html: `<div>${vehicle.line_number}</div>`
                        });
                    }

                    // Add marker with custom icon for each vehicle
                    L.marker([vehicle.latitude, vehicle.longitude], {
                        icon: customIcon
                    }).addTo(vehicleMarkers);
                });
            }
        }

        // Function to add markers for vehicles to the map
        async function addVehicleMarkers() {
            const vehicleData = await fetchVehicleData();
            if (vehicleData) {
                // Clear previous vehicle markers from the map
                vehicleMarkers.clearLayers();

                vehicleData.forEach(vehicle => {
                    var customIcon;
                    if (vehicle.vehicle_type === "bus") {
                        customIcon = L.divIcon({
                            className: 'bus-icon',
                            html: `<div>${vehicle.line_number}</div>`
                        });
                    } else if (vehicle.vehicle_type === "tram") {
                        customIcon = L.divIcon({
                            className: 'tram-icon',
                            html: `<div>${vehicle.line_number}</div>`
                        });
                    }

                    // Create marker with custom icon for each vehicle
                    var marker = L.marker([vehicle.latitude, vehicle.longitude], {
                        icon: customIcon
                    }).addTo(vehicleMarkers);

                    // Add tooltip or popup to show next stop information
                    var nextStopInfo = vehicle.next_stop ? vehicle.next_stop : "Unknown";
                    marker.bindTooltip(`Next Stop: ${nextStopInfo}`);
                    // If you want to use popup instead of tooltip, use marker.bindPopup() instead.
                });
            }
        }


        // Call functions to add vehicle markers initially
        addVehicleMarkers();

        // Create a layer group for vehicle markers
        var vehicleMarkers = L.layerGroup().addTo(map);

        // Update vehicle positions every 20 seconds
        setInterval(addVehicleMarkers, 20000);

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <style>
        .bus-icon {
            background-color: rgb(77, 77, 243);
            color: white;
            border-radius: 50%;
            padding: 12px;
            text-align: center;
            width: 30px;
            height: 30px;
            line-height: 15px;
        }

        .tram-icon {
            background-color: rgb(184, 13, 184);
            color: white;
            border-radius: 50%;
            padding: 12px;
            text-align: center;
            width: 30px;
            height: 30px;
            line-height: 15px;
        }

        .bus-icon,
        .tram-icon {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stop-icon {
            text-align: center;
            line-height: 30px;
        }
    </style>
</body>

</html>
