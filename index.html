<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Pojazdów</title>
    <!-- Styl Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Skrypt Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>

<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fa-solid fa-bus"></i> | Autobusy Szczecin</span>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>


    <!-- Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Menu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Pozycja Akordeonu #1
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Pozycja Akordeonu #2
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Ustawienia
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <!-- Przyciski wyboru typu mapy -->
                                    <div>
                                        <h6>Wybierz Typ Mapy: </h6>
                                        <label>
                                            <input type="radio" name="mapType" value="thunderforest"> Vehicles Light
                                            (Potrzebujesz klucza API)
                                        </label><br>
                                        <label>
                                            <input type="radio" name="mapType" value="thunderforest_dark"> Vehicles Dark
                                            (Potrzebujesz klucza API)
                                        </label><br>
                                        <label>
                                            <input type="radio" name="mapType" value="osm" checked> OpenStreetMap
                                        </label><br>

                                    </div>
                                    <br>
                                    <!-- Pole wprowadzania klucza API -->
                                    <div>
                                        <label for="apiKey">Klucz API:</label>
                                        <input type="text" id="apiKey">
                                        <button onclick="saveApiKey()">Zapisz</button>
                                    </div>
                                    <br><br>
                                    <div>Ta aplikacja zapewnia śledzenie na żywo autobusów i tramwajów w
                                        Szczecinie.<br><br>Dla więcej
                                        informacji lub aby przyczynić się, odwiedź: <br> <a
                                            href="https://github.com/Alexshch09/autobusy"
                                            target="_blank">https://github.com/Alexshch09/autobusy</a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="departureModal" tabindex="-1" aria-labelledby="departureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="departureModalLabel">Tablica odjazdów dla przystanku <span
                            id="stopName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Numer linii</th>
                                <th>Kierunek</th>
                                <th>Czas odjazdu</th>
                            </tr>
                        </thead>
                        <tbody id="departureTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div style="height: 93vh;">
        <div id="map" style="height: 100%;"></div>
    </div>


    <script>
        var mapType = getSavedMapType() || "osm";
        var apiKey = getSavedApiKey();



        function initMap() {
            // Check if geolocation is supported by the browser
            if ('geolocation' in navigator) {
                // Request the user's location
                navigator.geolocation.getCurrentPosition(
                    // Success callback function
                    function (position) {
                        // Get the user's coordinates
                        var userLat = position.coords.latitude;
                        var userLng = position.coords.longitude;

                        // Initialize the map with the user's location
                        map.setView([userLat, userLng], 18);
                    },
                    // Error callback function
                    function (error) {
                        console.error('Error getting user location:', error);
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
            }
        }

        // Call the initMap function when the page is loaded
        document.addEventListener('DOMContentLoaded', initMap);



        // Inicjalizacja mapy Leaflet
        var map = L.map('map', {
            minZoom: 12, // Minimalne przybliżenie
            maxZoom: 19 // Maksymalne przybliżenie
        }).setView([53.441, 14.563360], 18);

        var southWest = L.latLng(53.6, 14.4),
            northEast = L.latLng(53.225, 14.8),
            bounds = L.latLngBounds(southWest, northEast);

        map.setMaxBounds(bounds);
        map.on('drag', function () {
            map.panInsideBounds(bounds, { animate: false });
        });

        var tileLayer;
        changeTileLayer(mapType);

        function changeTileLayer(mapType) {
            if (mapType === "thunderforest") {
                if (!apiKey) {
                    alert("Proszę podać klucz API. Możesz go uzyskać na stronie Thunderforest.");
                    return;
                }
                tileLayer = L.tileLayer('https://a.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=' + apiKey, {
                    maxZoom: 19,
                });
            } else if (mapType === "thunderforest_dark") {
                if (!apiKey) {
                    alert("Proszę podać klucz API. Możesz go uzyskać na stronie Thunderforest.");
                    return;
                }
                tileLayer = L.tileLayer('https://a.tile.thunderforest.com/transport-dark/{z}/{x}/{y}.png?apikey=' + apiKey, {
                    maxZoom: 19,
                });
            }
            else if (mapType === "osm") {
                tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                });
            }

            map.eachLayer(function (layer) {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });

            tileLayer.addTo(map);
            document.querySelector('input[name="mapType"][value="' + mapType + '"]').checked = true;
        }

        // Funkcja do pobierania danych pojazdów z API
        async function fetchVehicleData() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/vehicles');
                const data = await response.json();
                return data.data; // Zwróć tylko tablicę 'data' z odpowiedzi
            } catch (error) {
                console.error('Błąd podczas pobierania danych pojazdów:', error);
                return [];
            }
        }

        // Funkcja do zapisywania klucza API w ciasteczku
        function saveApiKey() {
            apiKey = document.getElementById("apiKey").value;
            document.cookie = "apiKey=" + apiKey + "; expires=Infinity";
        }

        // Funkcja do pobierania zapisanego klucza API z ciasteczka
        function getSavedApiKey() {
            const cookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("apiKey="));
            if (cookie) {
                return cookie.split("=")[1];
            }
            return null;
        }

        // Funkcja do zapisywania typu mapy w ciasteczku
        function saveMapType(mapType) {
            document.cookie = "mapType=" + mapType + "; expires=Infinity";
        }

        // Funkcja do pobierania zapisanego typu mapy z ciasteczka
        function getSavedMapType() {
            const cookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("mapType="));
            if (cookie) {
                return cookie.split("=")[1];
            }
            return null;
        }

        // Dodaj nasłuchiwanie zdarzeń na przyciskach radio do zmiany typu mapy
        document.querySelectorAll('input[name="mapType"]').forEach(input => {
            input.addEventListener("change", function () {
                mapType = this.value;
                saveMapType(mapType);
                changeTileLayer(mapType);
            });
        });

        // Funkcja do dodawania znaczników dla pojazdów na mapie
        async function addVehicleMarkers() {
            const vehicleData = await fetchVehicleData();
            if (vehicleData) {
                // Wyczyść poprzednie znaczniki pojazdów z mapy
                vehicleMarkers.clearLayers();

                vehicleData.forEach(vehicle => {
                    var customIcon;
                    if (vehicle.vehicle_type === "bus") {
                        customIcon = L.divIcon({
                            className: 'bus-icon',
                            html: `<div>${vehicle.line_number}</div>`
                        });
                    } else if (vehicle.vehicle_type === "tram") {
                        customIcon = L.divIcon({
                            className: 'tram-icon',
                            html: `<div>${vehicle.line_number}</div>`
                        });
                    }

                    // Utwórz znacznik z niestandardową ikoną dla każdego pojazdu
                    var marker = L.marker([vehicle.latitude, vehicle.longitude], {
                        icon: customIcon
                    }).addTo(vehicleMarkers);

                    // Dodaj podpowiedź lub komunikat do wyświetlenia dodatkowych informacji
                    var nextStopInfo = vehicle.next_stop ? vehicle.next_stop : "Nieznane";
                    var directionInfo = vehicle.direction ? vehicle.direction : "Nieznane";
                    var puncInfo = vehicle.punctuality ? vehicle.punctuality : "Nieznane";
                    var velInfo = vehicle.velocity ? vehicle.velocity : "Nieznane";
                    var updateInfo = vehicle.updated_at ? new Date(vehicle.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "Nieznane";
                    marker.bindTooltip(
                        `Następny Przystanek: ${nextStopInfo}
                        <br>
                        Kierunek: ${directionInfo}
                        <br>
                        Punktualność: ${puncInfo}
                        <br>
                        Prędkość: ${velInfo} km/h
                        <br>
                        Ostatnia Aktualizacja: ${updateInfo}`
                    );
                });
            }
        }


        // Создание отдельного слоя для маркеров
        const busStopLayer = L.layerGroup().addTo(map);

        async function fetchBusStops() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/stops');
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Error fetching bus stops data:', error);
                return [];
            }
        }

        function renderVisibleBusStops(stopsData) {
            const mapBounds = map.getBounds();
            const zoomLevel = map.getZoom();
            const maxZoomToShowStops = 15; // Adjust this value as needed

            // Clear existing markers from the bus stop layer
            busStopLayer.clearLayers();

            if (zoomLevel <= maxZoomToShowStops) {
                // Do not display stops if zoom level is too high
                return;
            }

            stopsData.forEach(stop => {
                const stopLatLng = L.latLng(stop.latitude, stop.longitude);
                if (mapBounds.contains(stopLatLng)) {
                    const marker = L.marker(stopLatLng).addTo(busStopLayer);
                    
                    marker.bindPopup(`
                <div>
                    <p>Numer przystanku: ${stop.number}</p>
                    <p>Na żądanie: ${stop.request_stop ? 'Tak' : 'Nie'}</p>
                    <p>Parking: ${stop.park_and_ride ? 'Tak' : 'Nie'}</p>
                    <button type="button" id="open_stop_modal" class="btn btn-primary" data-bs-toggle="modal" data-stop-number="${stop.number}" data-bs-target="#departureModal">Pokaż odjazdy</button>
                </div>`);
                }
            });
        }

        // При изменении масштаба карты вызываем функцию для отображения видимых остановок
        map.on('zoomend', () => {
            renderVisibleBusStops(busStopsData);
        });

        // Обновление видимых остановок при движении карты
        map.on('moveend', () => {
            renderVisibleBusStops(busStopsData);
        });

        // Инициализация процесса получения данных об остановках и отображения их на карте
        let busStopsData = [];
        fetchBusStops().then(data => {
            busStopsData = data;
            renderVisibleBusStops(busStopsData);
        }).catch(error => {
            console.error('Error fetching bus stops data:', error);
        });


        async function fetchAndPopulateDepartures(stopNumber) {
            try {
                const response = await fetch(`https://www.zditm.szczecin.pl/api/v1/displays/${stopNumber}`);
                const data = await response.json();

                // Set stop name in modal header
                document.getElementById('stopName').innerText = data.stop_name;

                // Clear previous table rows
                document.getElementById('departureTableBody').innerHTML = '';

                // Populate table with departures
                data.departures.forEach(departure => {
                    const realTime = departure.time_real !== null ? departure.time_real + ' min' : '';
                    const scheduledTime = departure.time_scheduled !== null ? departure.time_scheduled : '';

                    const row = `<tr>
                <td>${departure.line_number}</td>
                <td>${departure.direction}</td>
                <td>${realTime} ${scheduledTime}</td>
            </tr>`;

                    document.getElementById('departureTableBody').innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching and populating departures:', error);
            }
        }

        document.addEventListener('click', function (event) {
            // Sprawdź, czy kliknięty element to przycisk z atrybutem danych data-stop-number
            if (event.target.matches('[data-stop-number]')) {
                // Pobierz numer przystanku z atrybutu danych
                const stopNumber = event.target.getAttribute('data-stop-number');
                // Wywołaj funkcję, aby pobrać i wyświetlić odjazdy dla tego przystanku
                fetchAndPopulateDepartures(stopNumber);
            }
        });

        

        // Wywołaj funkcje do początkowego dodawania znaczników pojazdów
        addVehicleMarkers();

        // Utwórz grupę warstw dla znaczników pojazdów
        var vehicleMarkers = L.layerGroup().addTo(map);

        // Aktualizuj pozycje pojazdów co 20 sekund
        setInterval(addVehicleMarkers, 20000);

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <style>
        .bus-icon {
            background-color: rgb(77, 77, 243);
            color: white;
            border-radius: 50%;
            padding: 12px;
            text-align: center;
            width: 30px;
            height: 30px;
            line-height: 15px;
        }

        .tram-icon {
            background-color: rgb(184, 13, 184);
            color: white;
            border-radius: 50%;
            padding: 12px;
            text-align: center;
            width: 30px;
            height: 30px;
            line-height: 15px;
        }

        .bus-icon,
        .tram-icon {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stop-icon {
            text-align: center;
            line-height: 30px;
        }
    </style>
</body>

</html>
