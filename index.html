<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Pojazd√≥w</title>
    <!-- Styl Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Skrypt Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>

<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fa-solid fa-bus"></i> | Autobusy Szczecin</span>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>


    <!-- Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Menu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Wybierz Wyswietlane Autobusy:
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Ustawienia
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <!-- Przycisk–∏ wyboru typu mapy -->
                                    <div>
                                        <h6>Wybierz Typ Mapy: </h6>
                                        <label>
                                            <input type="radio" name="mapType" value="thunderforest_transport"> Vehicles
                                            Light
                                            (Potrzebujesz klucza API)
                                        </label><br>
                                        <label>
                                            <input type="radio" name="mapType" value="osm" checked> OpenStreetMap
                                        </label><br>
                                        <div id="advancedModeToggle">
                                            <input type="checkbox" id="advancedModeCheckbox"
                                                onchange="toggleAdvancedMode()">
                                            <label for="advancedModeCheckbox">Rozszerzony tryb</label>
                                        </div>
                                        <div id="advancedOptions" style="display:none;">
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_transportdark">
                                                Thunderforest Vehicles Dark
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_landscape">
                                                Thunderforest Landscape
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_outdoors">
                                                Thunderforest Outdoors
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_cycle">
                                                Thunderforest OpenCycleMap
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_mobile-atlas">
                                                Thunderforest Mobile Atlas
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_neighbourhood">
                                                Thunderforest Neighbourhood
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_atlas">
                                                Thunderforest Atlas
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                        </div>
                                        <div id="hiddenContainer"
                                            style="display:none; background-color: rgba(255, 0, 0, 0.527); border-radius: 10%; padding: 50px;">
                                            <h5>Easter Egg: </h5>
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_pioneer">
                                                Thunderforest Pioneer
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                            <label>
                                                <input type="radio" name="mapType" value="thunderforest_spinal">
                                                Thunderforest Spinal Map
                                                (Potrzebujesz klucza API)
                                            </label><br>
                                        </div>
                                    </div>
                                    <br>
                                    <!-- Pole wprowadzania klucza API -->
                                    <div>
                                        <label for="apiKey">Klucz API:</label>
                                        <input type="text" id="apiKey">
                                        <button onclick="saveApiKey()">Zapisz</button>
                                    </div>

                                    <br>
                                    <hr>
                                    <br>
                                    <div>
                                        <h5>Ustawienia Kolorow:</h5>

                                        <table>
                                            <tr>
                                                <td><label for="lineColorPicker">Kolor Linii: </label></td>
                                                <td>&nbsp;</td>
                                                <td><input id="lineColorPicker" type="color" value="#555555" /></td>
                                            </tr>
                                            <tr>
                                                <td><label for="busColorPicker">Kolor Autobus√≥w: </label></td>
                                                <td>&nbsp;</td>
                                                <td><input id="busColorPicker" type="color" value="#555555" /></td>
                                            </tr>
                                            <tr>
                                                <td><label for="tramColorPicker">Kolor Tramwaj√≥w: </label></td>
                                                <td>&nbsp;</td>
                                                <td><input id="tramColorPicker" type="color" /></td>
                                            </tr>
                                            <tr>
                                                <td><label for="gpsColorPicker">Kolor znacznika GPS: </label></td>
                                                <td>&nbsp;</td>
                                                <td><input id="gpsColorPicker" type="color" /></td>
                                            </tr>
                                        </table>
                                        <br>
                                        <h6>Zrestartuj aplikacjƒô, aby zastosowaƒá wszystkie kolory.</h6>
                                        <br>
                                        <button onclick="saveColors()">Zapisz</button>
                                    </div>

                                    <br>
                                    <hr><br>
                                    <div>Ta aplikacja zapewnia ≈õledzenie na ≈ºywo autobus√≥w i tramwaj√≥w w Szczecinie.
                                        <br><br>
                                        <center><i class="fa-solid fa-code fa-beat" id="codeIcon"></i></center><br>
                                        Dla wiƒôcej informacji lub aby przyczyniƒá siƒô, odwied≈∫: <br> <a
                                            href="https://github.com/Alexshch09/autobusy" id="easter_egg_text"
                                            target="_blank">https://github.com/Alexshch09/autobusy</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="departureModal" tabindex="-1" aria-labelledby="departureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="departureModalLabel">Tablica odjazd√≥w dla przystanku <span
                            id="stopName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Numer linii</th>
                                <th>Kierunek</th>
                                <th>Czas odjazdu</th>
                            </tr>
                        </thead>
                        <tbody id="departureTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div style="height: 93vh;">
        <div id="map" style="height: 100%;">
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        let clickCount = 0;
        const codeIcon = document.getElementById('codeIcon');
        const hiddenContainer = document.getElementById('hiddenContainer');


        const rhythmPattern = [200, 150, 180, 380, 300, 320, 150, 160, 300]; // Attack on Titan Season 1 - Opening 1 | Guren no Yumiya

        let clickIndex = 0;
        let lastClickTime = 0;

        codeIcon.addEventListener('click', function () {
            let currentTime = new Date().getTime();
            let timeDiff = currentTime - lastClickTime;
            console.log(timeDiff);

            if (clickIndex === 0) {
                clickIndex++;
                console.log(clickIndex);
                lastClickTime = currentTime;
                document.getElementById('easter_egg_text').innerText = `https://github.com/Alexshch${clickIndex}9/autobusy`;
                return;
            }

            if (timeDiff >= rhythmPattern[clickIndex] -100 && timeDiff <= rhythmPattern[clickIndex] + 200) {
                clickIndex++;
                document.getElementById('easter_egg_text').innerText = `https://github.com/Alexshch${clickIndex}9/autobusy`;
                console.log(clickIndex);

                if (clickIndex === 9) {
                    Swal.fire({
                        title: "EASTER EGG!",
                        text: "Znalaz≈Çe≈õ Easter Egg! üòä Odblokowa≈Çe≈õ dwa nowe typy mapy. üó∫Ô∏è",
                        imageUrl: "https://i.pinimg.com/originals/c4/cf/26/c4cf2601c4e2578ee04c1a1f99a26fda.jpg",
                        imageWidth: 400,
                        imageHeight: 400
                    });
                    hiddenContainer.style.display = 'block';
                    clickIndex = 0;
                }

                lastClickTime = currentTime;
            } else {
                clickIndex = 0;
                lastClickTime = currentTime;
            }
        });

    </script>

    <script>

        function toggleAdvancedMode() {
            const advancedOptions = document.getElementById('advancedOptions');
            const advancedModeCheckbox = document.getElementById('advancedModeCheckbox');
            if (advancedModeCheckbox.checked) {
                advancedOptions.style.display = 'block';
            } else {
                advancedOptions.style.display = 'none';
            }
        }



        function areCookiesEnabled() {
            document.cookie = "testCookie=testValue";
            var cookieEnabled = document.cookie.indexOf("testCookie=testValue") !== -1;
            document.cookie = "testCookie=testValue; expires=Thu, 01 Jan 1970 00:00:00 UTC";

            return cookieEnabled;
        }

        document.addEventListener("DOMContentLoaded", async function () {
            if (!areCookiesEnabled()) {
                alert("Proszƒô w≈ÇƒÖczyƒá obs≈Çugƒô plik√≥w cookie w ustawieniach przeglƒÖdarki, aby uzyskaƒá dostƒôp do tej witryny.");
                window.close();
            }
        });


        document.addEventListener("DOMContentLoaded", async function () {
            var d1 = document.getElementsByClassName('leaflet-control-container')[0];
            d1 = d1.getElementsByClassName('leaflet-top leaflet-left')[0];

            d1.insertAdjacentHTML('beforeend', `<div class="leaflet-bar leaflet-control leaflet-control-zoom" style="width: 34px;">
        <a onclick="initMap()" aria-label="Update Location"
            title="Update Location" type="button"
            style="width:30px; height:30px; padding-top:1px; text-align: center; font-size:22px;">
            <i class="fa-solid fa-location-crosshairs"></i>
        </a>
    </div>
            `);
        });

    </script>


    <script>

        function saveColors() {
            const lineColor = document.getElementById('lineColorPicker').value;
            document.cookie = `lineColor=${lineColor}; expires=Fri, 31 Dec 9999 23:59:59 GMT`;

            const busColor = document.getElementById('busColorPicker').value;
            document.cookie = `busColor=${busColor}; expires=Fri, 31 Dec 9999 23:59:59 GMT`;

            const tramColor = document.getElementById('tramColorPicker').value;
            document.cookie = `tramColor=${tramColor}; expires=Fri, 31 Dec 9999 23:59:59 GMT`;

            const gpsColor = document.getElementById('gpsColorPicker').value;
            document.cookie = `gpsColor=${gpsColor}; expires=Fri, 31 Dec 9999 23:59:59 GMT`;
        }

        function readColor(co) {
            const colorDict = {
                lineColor: 'green',
                busColor: 'rgb(77, 77, 243)',
                tramColor: 'rgb(184, 13, 184)',
                gpsColor: 'blue',
            };

            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith(`${co}=`));

            if (cookieValue) {
                return cookieValue.split('=')[1];
            } else if (colorDict.hasOwnProperty(co)) {
                return colorDict[co];
            } else {
                return 'green';
            }
        }



        function applyColors() {

            document.getElementById('lineColorPicker').value = readColor('lineColor');
            document.getElementById('busColorPicker').value = readColor('busColor');
            document.getElementById('tramColorPicker').value = readColor('tramColor');
            document.getElementById('gpsColorPicker').value = readColor('gpsColor');




            const busBackgroundColor = readColor('busColor');
            const tramBackgroundColor = readColor('tramColor');

            document.documentElement.style.setProperty('--bus-bg-color', busBackgroundColor);
            document.documentElement.style.setProperty('--tram-bg-color', tramBackgroundColor);
        }


        document.addEventListener('DOMContentLoaded', applyColors);


    </script>


    <script>
        //-------------------------------------------------------------------------------------------------------------------------------------
        // Settings
        //-------------------------------------------------------------------------------------------------------------------------------------

        var speed = 10000;

        //-------------------------------------------------------------------------------------------------------------------------------------

        var mapType = getSavedMapType() || "osm";
        var apiKey = getSavedApiKey();
        console.log(apiKey)


        //-------------------------------------------------------------------------------------------------------------------------------------



        var gpsLayer = L.layerGroup(); // –°–æ–∑–¥–∞–µ–º —Å–ª–æ–π –¥–ª—è –º–µ—Ç–∫–∏ GPS

        function initMap() {
            // Check if geolocation is supported by the browser
            if ('geolocation' in navigator) {
                // Request the user's location
                navigator.geolocation.getCurrentPosition(
                    // Success callback function
                    function (position) {
                        // Get the user's coordinates
                        var userLat = position.coords.latitude;
                        var userLng = position.coords.longitude;

                        // Initialize the map with the user's location
                        map.setView([userLat, userLng], 18);

                        var customIcon = L.divIcon({
                            className: 'custom-icon',
                            html: `<i class="fa-solid fa-location-dot slow-beat" style="color:${readColor('gpsColor')}; font-size:16px;"></i>`,
                            iconSize: [16, 16], // Size of the icon
                        });

                        // Clear the GPS layer before adding new marker
                        gpsLayer.clearLayers();

                        // Add marker with custom icon to the GPS layer
                        L.marker([userLat, userLng], { icon: customIcon }).addTo(gpsLayer)
                            .bindPopup('Your Location');

                        // Add the GPS layer to the map
                        gpsLayer.addTo(map);
                    },
                    // Error callback function
                    function (error) {
                        console.error('Error getting user location:', error);
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
            }
        }


        // Call the initMap function when the page is loaded
        document.addEventListener('DOMContentLoaded', initMap);


        document.addEventListener("DOMContentLoaded", function () {
            const apiUrl = 'https://www.zditm.szczecin.pl/api/v1/timetable-change-descriptions';

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const accordion = document.getElementById('accordionExample');
                    data.data.forEach(change => {
                        const card = document.createElement('div');
                        card.className = 'accordion-item';

                        const cardHeader = document.createElement('h2');
                        cardHeader.className = 'accordion-header';
                        cardHeader.innerHTML = `
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${change.id}" aria-expanded="false" aria-controls="collapse${change.id}">
                    Zmiany Rozkladu
                </button>
            `;
                        card.appendChild(cardHeader);

                        const cardBody = document.createElement('div');
                        cardBody.id = `collapse${change.id}`;
                        cardBody.className = 'accordion-collapse collapse';
                        cardBody.setAttribute('data-bs-parent', '#accordionExample');
                        cardBody.innerHTML = `
                <div class="accordion-body">
                    ${change.description.pl}
                </div>
            `;
                        card.appendChild(cardBody);

                        accordion.appendChild(card);
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        });


        //-------------------------------------------------------------------------------------------------------------------------------------



        // Inicjalizacja mapy Leaflet
        var map = L.map('map', {
            minZoom: 12, // Minimalne przybli≈ºenie
            maxZoom: 19 // Maksymalne przybli≈ºenie
        }).setView([53.441, 14.563360], 18);

        var southWest = L.latLng(53.6, 14.4),
            northEast = L.latLng(53.225, 14.8),
            bounds = L.latLngBounds(southWest, northEast);

        map.setMaxBounds(bounds);
        map.on('drag', function () {
            map.panInsideBounds(bounds, { animate: false });
        });

        var tileLayer;
        changeTileLayer(mapType);

        function changeTileLayer(mapType) {
            const thunderforestMaps = {
                "cycle": "cycle",
                "transport": "transport",
                "landscape": "landscape",
                "outdoors": "outdoors",
                "transportdark": "transport-dark",
                "spinal": "spinal-map",
                "pioneer": "pioneer",
                "mobile-atlas": "mobile-atlas",
                "neighbourhood": "neighbourhood",
                "atlas": "atlas"
            };

            let tileUrl;
            if (mapType.startsWith("thunderforest")) {
                const mapName = mapType.split("_")[1];
                if (!apiKey) {
                    swal({
                        title: "B≈ÇƒÖd API",
                        text: "Proszƒô podaƒá klucz API. Mo≈ºesz go uzyskaƒá na stronie Thunderforest.",
                        icon: "error",
                    });
                    tileUrl = `https://tile.thunderforest.com/${thunderforestMaps[mapName]}/{z}/{x}/{y}.png`;
                } else {
                    tileUrl = `https://tile.thunderforest.com/${thunderforestMaps[mapName]}/{z}/{x}/{y}.png?apikey=${apiKey}`;
                }
            } else if (mapType === "osm") {
                tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            }

            if (tileUrl) {
                tileLayer = L.tileLayer(tileUrl, {
                    maxZoom: 19,
                });

                map.eachLayer(function (layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });

                tileLayer.addTo(map);
                document.querySelector('input[name="mapType"][value="' + mapType + '"]').checked = true;
            }
        }




        //-------------------------------------------------------------------------------------------------------------------------------------


        // Funkcja do zapisywania klucza API w ciasteczku
        function saveApiKey() {
            apiKey = document.getElementById("apiKey").value;
            document.cookie = "apiKey=" + apiKey + "; expires=Infinity";
        }

        // Funkcja do pobierania zapisanego klucza API z ciasteczka
        function getSavedApiKey() {
            const cookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("apiKey="));
            if (cookie) {
                return cookie.split("=")[1];
            }
            return null;
        }

        // Funkcja do zapisywania typu mapy w ciasteczku
        function saveMapType(mapType) {
            document.cookie = "mapType=" + mapType + "; expires=Infinity";
        }

        // Funkcja do pobierania zapisanego typu mapy z ciasteczka
        function getSavedMapType() {
            const cookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("mapType="));
            if (cookie) {
                return cookie.split("=")[1];
            }
            return null;
        }

        // Dodaj nas≈Çuchiwanie zdarze≈Ñ na przyciskach radio do zmiany typu mapy
        document.querySelectorAll('input[name="mapType"]').forEach(input => {
            input.addEventListener("change", function () {
                mapType = this.value;
                saveMapType(mapType);
                changeTileLayer(mapType);
            });
        });



        //-------------------------------------------------------------------------------------------------------------------------------------
        // Markers for buses
        //-------------------------------------------------------------------------------------------------------------------------------------

        // Funkcja do pobierania danych pojazd√≥w z API
        async function fetchVehicleData() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/vehicles');
                const data = await response.json();
                return data.data; // Zwr√≥ƒá tylko tablicƒô 'data' z odpowiedzi
            } catch (error) {
                console.error('B≈ÇƒÖd podczas pobierania danych pojazd√≥w:', error);
                return [];
            }
        }

        function saveSelectedLinesToCookie(selectedLines) {
            document.cookie = `selectedLines=${JSON.stringify(selectedLines)}; expires=${new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toUTCString()}; path=/`;
        }

        function getSelectedLinesFromCookie() {
            const cookies = document.cookie.split(';').map(cookie => cookie.trim());
            const selectedLinesCookie = cookies.find(cookie => cookie.startsWith('selectedLines='));
            if (selectedLinesCookie) {
                return JSON.parse(selectedLinesCookie.split('=')[1]);
            } else if (!selectedLinesCookie) {
                console.log('No cookies');
                createAllLines();
            }
            return [];
        }

        async function createAllLines() {
            const linesData = await fetchLinesData();
            const allLines = linesData.map(line => line.number);
            document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            createLineButtons()
            saveSelectedLinesToCookie(allLines);
        }

        async function addVehicleMarkers() {
            const vehicleData = await fetchVehicleData();
            let selectedLines = getSelectedLinesFromCookie();

            if (vehicleData) {
                vehicleMarkers.clearLayers();

                vehicleData.forEach(vehicle => {

                    if (selectedLines.includes(vehicle.line_number)) {
                        var customIcon;
                        if (vehicle.vehicle_type === "bus") {
                            customIcon = L.divIcon({
                                className: 'bus-icon',
                                html: `<div>${vehicle.line_number}</div>`
                            });
                        } else if (vehicle.vehicle_type === "tram") {
                            customIcon = L.divIcon({
                                className: 'tram-icon',
                                html: `<div>${vehicle.line_number}</div>`
                            });
                        }

                        // Tworzenie znacznika z niestandardowƒÖ ikonƒÖ dla ka≈ºdego pojazdu
                        var marker = L.marker([vehicle.latitude, vehicle.longitude], {
                            icon: customIcon
                        }).addTo(vehicleMarkers);

                        marker.on('mouseover', function () {
                            drawLineTrajectory(vehicle.line_id, vehicle.route_variant_number);
                        });

                        marker.on('mouseout', function () {
                            removeLineTrajectory(vehicle.line_id);
                        });

                        // Dodawanie podpowiedzi do wy≈õwietlania dodatkowych informacji
                        var nextStopInfo = vehicle.next_stop ? vehicle.next_stop : "Nieznane";
                        var directionInfo = vehicle.direction ? vehicle.direction : "Nieznane";
                        var puncInfo = vehicle.punctuality ? vehicle.punctuality : "Nieznane";
                        var velInfo = vehicle.velocity ? vehicle.velocity : "Nieznane";
                        var updateInfo = vehicle.updated_at ? new Date(vehicle.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "Nieznane";
                        marker.bindTooltip(
                            `Nastƒôpny przystanek: ${nextStopInfo}
                    <br>
                    Kierunek: ${directionInfo}
                    <br>
                    Punktualno≈õƒá: ${puncInfo}
                    <br>
                    Prƒôdko≈õƒá: ${velInfo} km/h
                    <br>
                    Ostatnia aktualizacja: ${updateInfo}`,
                            {
                                offset: [50, 0],
                                opacity: 0.75
                            }
                        );
                    }
                });
            }
        }




        //------------------------------------------------------------------------------------------------------------------------------------
        // 2. Markers for bus stops
        //------------------------------------------------------------------------------------------------------------------------------------


        // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
        const busStopLayer = L.layerGroup().addTo(map);

        async function fetchBusStops() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/stops');
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Error fetching bus stops data:', error);
                return [];
            }
        }

        function renderVisibleBusStops(stopsData) {
            const mapBounds = map.getBounds();
            const zoomLevel = map.getZoom();
            const maxZoomToShowStops = 15; // Adjust this value as needed

            // Clear existing markers from the bus stop layer
            busStopLayer.clearLayers();

            if (zoomLevel <= maxZoomToShowStops) {
                // Do not display stops if zoom level is too high
                return;
            }

            stopsData.forEach(stop => {
                const stopLatLng = L.latLng(stop.latitude, stop.longitude);
                if (mapBounds.contains(stopLatLng)) {
                    const marker = L.marker(stopLatLng).addTo(busStopLayer);

                    marker.bindTooltip(`
                <div>
                    <p>Numer przystanku: ${stop.number}</p>
                    <p>Na ≈ºƒÖdanie: ${stop.request_stop ? 'Tak' : 'Nie'}</p>
                    <p>Parking: ${stop.park_and_ride ? 'Tak' : 'Nie'}</p>
                    <button type="button" id="open_stop_modal" class="btn btn-primary" data-bs-toggle="modal" data-stop-number="${stop.number}" style="display: none;" data-bs-target="#departureModal">Poka≈º odjazdy</button>
                </div>`).on('click', function () {
                        fetchAndPopulateDepartures(stop.number);
                        const modalButton = document.getElementById('open_stop_modal');
                        modalButton.click();
                    });;
                }
            });
        }

        map.on('zoomend', () => {
            renderVisibleBusStops(busStopsData);
        });

        map.on('moveend', () => {
            renderVisibleBusStops(busStopsData);
        });

        let busStopsData = [];
        fetchBusStops().then(data => {
            busStopsData = data;
            renderVisibleBusStops(busStopsData);
        }).catch(error => {
            console.error('Error fetching bus stops data:', error);
        });


        async function fetchAndPopulateDepartures(stopNumber) {
            try {
                const response = await fetch(`https://www.zditm.szczecin.pl/api/v1/displays/${stopNumber}`);
                const data = await response.json();

                // Set stop name in modal header
                document.getElementById('stopName').innerText = data.stop_name;

                // Clear previous table rows
                document.getElementById('departureTableBody').innerHTML = '';

                // Populate table with departures
                data.departures.forEach(departure => {
                    const realTime = departure.time_real !== null ? departure.time_real + ' min' : '';
                    const scheduledTime = departure.time_scheduled !== null ? departure.time_scheduled : '';

                    const row = `<tr>
                <td>${departure.line_number}</td>
                <td>${departure.direction}</td>
                <td>${realTime} ${scheduledTime}</td>
            </tr>`;

                    document.getElementById('departureTableBody').innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching and populating departures:', error);
            }
        }

        document.addEventListener('click', function (event) {
            // Sprawd≈∫, czy klikniƒôty element to przycisk z atrybutem danych data-stop-number
            if (event.target.matches('[data-stop-number]')) {
                // Pobierz numer przystanku z atrybutu danych
                const stopNumber = event.target.getAttribute('data-stop-number');
                // Wywo≈Çaj funkcjƒô, aby pobraƒá i wy≈õwietliƒá odjazdy dla tego przystanku
                fetchAndPopulateDepartures(stopNumber);
            }
        });


        async function fetchLinesData() {
            const response = await fetch('https://www.zditm.szczecin.pl/api/v1/lines');
            const data = await response.json();
            return data.data;
        }

        async function createLineButtons() {
            const linesData = await fetchLinesData();
            const selectedLines = getSelectedLinesFromCookie();
            document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            const accordionBody = document.querySelector('.accordion-body');

            const tramsContainer = document.createElement('div');

            const AccTitle = document.createElement('h2');
            AccTitle.textContent = 'Wybierz Wy≈õwietlane Linie:';
            tramsContainer.appendChild(AccTitle);

            const br = document.createElement('br');
            tramsContainer.appendChild(br);

            const tramsData = linesData.filter(line => line.vehicle_type === 'tram');
            const dayBusesData = linesData.filter(line => line.vehicle_type === 'bus' && line.type === 'day');
            const nightBusesData = linesData.filter(line => line.vehicle_type === 'bus' && line.type === 'night');

            tramsContainer.classList.add('mb-3');
            const tramsTitle = document.createElement('h5');
            tramsTitle.textContent = 'Tramwaje:';
            tramsContainer.appendChild(tramsTitle);
            tramsData.forEach(line => {
                const button = createButton(line, selectedLines);
                button.classList.add('me-1', 'me-md-2');
                button.setAttribute('id', `line_${line.number}`);
                tramsContainer.appendChild(button);
            });
            accordionBody.appendChild(tramsContainer);

            const dayBusesContainer = document.createElement('div');

            const dayBusesTitle = document.createElement('h5');
            dayBusesTitle.textContent = 'Autobusy (Dzie≈Ñ):';
            dayBusesContainer.appendChild(dayBusesTitle);
            dayBusesData.forEach(line => {
                const button = createButton(line, selectedLines);
                button.classList.add('me-1', 'me-md-2');
                button.setAttribute('id', `line_${line.number}`);
                dayBusesContainer.appendChild(button);
            });

            accordionBody.appendChild(dayBusesContainer);

            const nightBusesContainer = document.createElement('div');

            const nightBusesTitle = document.createElement('h5');
            nightBusesTitle.textContent = 'Autobusy (Noc):';
            nightBusesContainer.appendChild(nightBusesTitle);
            nightBusesData.forEach(line => {
                const button = createButton(line, selectedLines);
                button.classList.add('me-1', 'me-md-2');
                button.setAttribute('id', `line_${line.number}`);
                nightBusesContainer.appendChild(button);
            });

            accordionBody.appendChild(nightBusesContainer);

            const hr = document.createElement('hr');
            accordionBody.appendChild(hr);

            const enableAllButton = document.createElement('button');
            enableAllButton.classList.add('btn', 'btn-primary', 'mb-2', 'me-1', 'me-md-2');
            enableAllButton.textContent = 'W≈ÇƒÖcz Wszystko';
            enableAllButton.addEventListener('click', enableAllLines);
            accordionBody.appendChild(enableAllButton);

            const disableAllButton = document.createElement('button');
            disableAllButton.classList.add('btn', 'btn-primary', 'mb-2', 'ms-2');
            disableAllButton.textContent = 'Wy≈ÇƒÖcz Wszystko';
            disableAllButton.addEventListener('click', disableAllLines);
            accordionBody.appendChild(disableAllButton);
        }

        function createButton(line, selectedLines) {
            const button = document.createElement('button');
            button.classList.add('btn', 'btn-primary', 'mb-2');
            button.textContent = `${line.number}`;
            button.addEventListener('click', () => toggleLine(line.number));
            if (selectedLines.includes(line.number)) {
                button.classList.add('btn-success');
            } else {
                button.classList.add('btn-danger');
            }
            return button;
        }

        async function enableAllLines() {
            const linesData = await fetchLinesData();
            const allLines = linesData.map(line => line.number);
            saveSelectedLinesToCookie(allLines);
            addVehicleMarkers();
            document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            createLineButtons()
        }

        function disableAllLines() {
            saveSelectedLinesToCookie([]);
            addVehicleMarkers();
            document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            createLineButtons()
        }

        function toggleLine(lineNumber) {
            const selectedLines = getSelectedLinesFromCookie();
            if (selectedLines.includes(lineNumber)) {
                const index = selectedLines.indexOf(lineNumber);
                selectedLines.splice(index, 1);
            } else {
                selectedLines.push(lineNumber);
            }
            saveSelectedLinesToCookie(selectedLines);
            addVehicleMarkers();

            if (document.getElementById(`line_${lineNumber}`).classList.contains('btn-danger')) {
                document.getElementById(`line_${lineNumber}`).classList.remove('btn-danger');
                document.getElementById(`line_${lineNumber}`).classList.add('btn-success');
            } else if (document.getElementById(`line_${lineNumber}`).classList.contains('btn-success')) {
                document.getElementById(`line_${lineNumber}`).classList.remove('btn-success');
                document.getElementById(`line_${lineNumber}`).classList.add('btn-danger');
            }


            // document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            // createLineButtons()
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await createLineButtons();
            addVehicleMarkers();
        });



        //-------------------------------------------------------------------------------------------------------------------------------------



        // Wywo≈Çaj funkcje do poczƒÖtkowego dodawania znacznik√≥w pojazd√≥w
        addVehicleMarkers();

        // Utw√≥rz grupƒô warstw dla znacznik√≥w pojazd√≥w
        var vehicleMarkers = L.layerGroup().addTo(map);

        // Aktualizuj pozycje pojazd√≥w co 10 sekund
        setInterval(addVehicleMarkers, speed);




        //-------------------------------------------------------------------------------------------------------------------------------------

        // Funkcja do pobierania danych z API dla linii
        async function fetchLinesData() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/lines');
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania danych z API dotyczƒÖcych linii:', error);
                return [];
            }
        }

        // Tworzenie warstwa dla trajektorii linii
        const lineTrajectoryLayer = L.layerGroup().addTo(map);

        // Funkcja do rysowania trasy linii na mapie
        function drawLineTrajectory(lineId, variant) {
            console.log(`Drawing line ${lineId}`)
            fetch(`https://www.zditm.szczecin.pl/api/v1/trajectories/${lineId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('WystƒÖpi≈Ç b≈ÇƒÖd podczas pobierania danych.');
                    }
                    return response.json();
                })
                .then(data => {
                    const line = data.features.find(feature => feature.properties.route_variant_number === variant);
                    const coordinates = line.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    L.polyline(coordinates, { color: readColor('lineColor') }).addTo(lineTrajectoryLayer);
                })
                .catch(error => {
                    console.error('B≈ÇƒÖd pobierania danych z API dotyczƒÖcych trajektorii:', error);
                    swal({
                        title: "B≈ÇƒÖd Serwera",
                        text: `B≈ÇƒÖd pobierania trajektorii dotyczƒÖcych Linii`,
                        icon: "error",
                    });
                });
        }

        // Funkcja do usuwania trajektorii linii
        function removeLineTrajectory() {
            lineTrajectoryLayer.clearLayers(); // Usuwa wszystkie warstwy z warstwy linii trajektorii
        }



    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <style>
        .bus-icon {
            background-color: var(--bus-bg-color, rgb(77, 77, 243));
            color: white;
            border-radius: 50%;
            padding: 12px;
            text-align: center;
            width: 30px;
            height: 30px;
            line-height: 15px;
            border: 1px solid black;
        }

        .tram-icon {
            background-color: var(--tram-bg-color, rgb(184, 13, 184));
            color: white;
            border-radius: 50%;
            padding: 12px;
            text-align: center;
            width: 30px;
            height: 30px;
            line-height: 15px;
            border: 1px solid black;
        }

        .bus-icon,
        .tram-icon {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stop-icon {
            text-align: center;
            line-height: 30px;
        }
    </style>
    <style>
        input[type="color" i] {
            border-radius: 50%;
            inline-size: 30px;
            block-size: 30px;

            /* Can set padding between outer circle and color swatch for Firefox here;
   * it doesn't support a color-swarch-wrapper pseudoclass
   */
            padding: 3px;
            border-width: 1px;
            border-style: solid;
            border-color: rgb(153, 153, 153);
        }

        /* Affects area between outer circle and color swatch. Firefox doesn't have an equivalent. */
        input[type="color" i]::-webkit-color-swatch-wrapper {
            padding: 1px;
        }

        /* Affects the inner circle, i.e. the current color selection */
        input[type="color" i]::-webkit-color-swatch {
            border-radius: 50%;
        }

        input[type="color" i]::-moz-color-swatch {
            border-radius: 50%;
        }

        .color_input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .slow-beat {
            -webkit-animation: fa-beat 3s infinite linear;
            animation: fa-beat 3s infinite linear;
        }
    </style>
</body>

</html>