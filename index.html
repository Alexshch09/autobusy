<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Pojazdów</title>
    <!-- Styl Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Skrypt Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>

<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fa-solid fa-bus"></i> | Autobusy Szczecin</span>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>


    <!-- Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Menu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Wybierz Wyswietlane Autobusy:
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Ustawienia
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <!-- Przyciski wyboru typu mapy -->
                                    <div>
                                        <h6>Wybierz Typ Mapy: </h6>
                                        <label>
                                            <input type="radio" name="mapType" value="thunderforest"> Vehicles Light
                                            (Potrzebujesz klucza API)
                                        </label><br>
                                        <label>
                                            <input type="radio" name="mapType" value="thunderforest_dark"> Vehicles Dark
                                            (Potrzebujesz klucza API)
                                        </label><br>
                                        <label>
                                            <input type="radio" name="mapType" value="osm" checked> OpenStreetMap
                                        </label><br>

                                    </div>
                                    <br>
                                    <!-- Pole wprowadzania klucza API -->
                                    <div>
                                        <label for="apiKey">Klucz API:</label>
                                        <input type="text" id="apiKey">
                                        <button onclick="saveApiKey()">Zapisz</button>
                                    </div>
                                    <br><br>
                                    <div>Ta aplikacja zapewnia śledzenie na żywo autobusów i tramwajów w
                                        Szczecinie.<br><br>Dla więcej
                                        informacji lub aby przyczynić się, odwiedź: <br> <a
                                            href="https://github.com/Alexshch09/autobusy"
                                            target="_blank">https://github.com/Alexshch09/autobusy</a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="departureModal" tabindex="-1" aria-labelledby="departureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="departureModalLabel">Tablica odjazdów dla przystanku <span
                            id="stopName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Numer linii</th>
                                <th>Kierunek</th>
                                <th>Czas odjazdu</th>
                            </tr>
                        </thead>
                        <tbody id="departureTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div style="height: 93vh;">
        <div id="map" style="height: 100%;"></div>
    </div>


    <script>
        //-------------------------------------------------------------------------------------------------------------------------------------
        // Settings
        //-------------------------------------------------------------------------------------------------------------------------------------

        var speed = 10000;

        //-------------------------------------------------------------------------------------------------------------------------------------

        var mapType = getSavedMapType() || "osm";
        var apiKey = getSavedApiKey();


        //-------------------------------------------------------------------------------------------------------------------------------------



        function initMap() {
            // Check if geolocation is supported by the browser
            if ('geolocation' in navigator) {
                // Request the user's location
                navigator.geolocation.getCurrentPosition(
                    // Success callback function
                    function (position) {
                        // Get the user's coordinates
                        var userLat = position.coords.latitude;
                        var userLng = position.coords.longitude;

                        // Initialize the map with the user's location
                        map.setView([userLat, userLng], 18);
                    },
                    // Error callback function
                    function (error) {
                        console.error('Error getting user location:', error);
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
            }
        }

        // Call the initMap function when the page is loaded
        document.addEventListener('DOMContentLoaded', initMap);











        document.addEventListener("DOMContentLoaded", function () {
            const apiUrl = 'https://www.zditm.szczecin.pl/api/v1/timetable-change-descriptions';

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const accordion = document.getElementById('accordionExample');
                    data.data.forEach(change => {
                        const card = document.createElement('div');
                        card.className = 'accordion-item';

                        const cardHeader = document.createElement('h2');
                        cardHeader.className = 'accordion-header';
                        cardHeader.innerHTML = `
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${change.id}" aria-expanded="false" aria-controls="collapse${change.id}">
                    Zmiany Rozkladu
                </button>
            `;
                        card.appendChild(cardHeader);

                        const cardBody = document.createElement('div');
                        cardBody.id = `collapse${change.id}`;
                        cardBody.className = 'accordion-collapse collapse';
                        cardBody.setAttribute('data-bs-parent', '#accordionExample');
                        cardBody.innerHTML = `
                <div class="accordion-body">
                    ${change.description.pl}
                </div>
            `;
                        card.appendChild(cardBody);

                        accordion.appendChild(card);
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        });


        //-------------------------------------------------------------------------------------------------------------------------------------



        // Inicjalizacja mapy Leaflet
        var map = L.map('map', {
            minZoom: 12, // Minimalne przybliżenie
            maxZoom: 19 // Maksymalne przybliżenie
        }).setView([53.441, 14.563360], 18);

        var southWest = L.latLng(53.6, 14.4),
            northEast = L.latLng(53.225, 14.8),
            bounds = L.latLngBounds(southWest, northEast);

        map.setMaxBounds(bounds);
        map.on('drag', function () {
            map.panInsideBounds(bounds, { animate: false });
        });

        var tileLayer;
        changeTileLayer(mapType);

        function changeTileLayer(mapType) {
            if (mapType === "thunderforest") {
                if (!apiKey) {
                    swal({
                        title: "Błąd API",
                        text: "Proszę podać klucz API. Możesz go uzyskać na stronie Thunderforest.",
                        icon: "error",
                    });
                    return;
                }
                tileLayer = L.tileLayer('https://a.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=' + apiKey, {
                    maxZoom: 19,
                });
            } else if (mapType === "thunderforest_dark") {
                if (!apiKey) {
                    swal({
                        title: "Błąd API",
                        text: "Proszę podać klucz API. Możesz go uzyskać na stronie Thunderforest.",
                        icon: "error",
                    });
                    return;
                }
                tileLayer = L.tileLayer('https://a.tile.thunderforest.com/transport-dark/{z}/{x}/{y}.png?apikey=' + apiKey, {
                    maxZoom: 19,
                });
            }
            else if (mapType === "osm") {
                tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                });
            }

            map.eachLayer(function (layer) {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });

            tileLayer.addTo(map);
            document.querySelector('input[name="mapType"][value="' + mapType + '"]').checked = true;
        }



        //-------------------------------------------------------------------------------------------------------------------------------------


        // Funkcja do zapisywania klucza API w ciasteczku
        function saveApiKey() {
            apiKey = document.getElementById("apiKey").value;
            document.cookie = "apiKey=" + apiKey + "; expires=Infinity";
        }

        // Funkcja do pobierania zapisanego klucza API z ciasteczka
        function getSavedApiKey() {
            const cookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("apiKey="));
            if (cookie) {
                return cookie.split("=")[1];
            }
            return null;
        }

        // Funkcja do zapisywania typu mapy w ciasteczku
        function saveMapType(mapType) {
            document.cookie = "mapType=" + mapType + "; expires=Infinity";
        }

        // Funkcja do pobierania zapisanego typu mapy z ciasteczka
        function getSavedMapType() {
            const cookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("mapType="));
            if (cookie) {
                return cookie.split("=")[1];
            }
            return null;
        }

        // Dodaj nasłuchiwanie zdarzeń na przyciskach radio do zmiany typu mapy
        document.querySelectorAll('input[name="mapType"]').forEach(input => {
            input.addEventListener("change", function () {
                mapType = this.value;
                saveMapType(mapType);
                changeTileLayer(mapType);
            });
        });



        //-------------------------------------------------------------------------------------------------------------------------------------
        // Markers for buses
        //-------------------------------------------------------------------------------------------------------------------------------------

        // Funkcja do pobierania danych pojazdów z API
        async function fetchVehicleData() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/vehicles');
                const data = await response.json();
                return data.data; // Zwróć tylko tablicę 'data' z odpowiedzi
            } catch (error) {
                console.error('Błąd podczas pobierania danych pojazdów:', error);
                return [];
            }
        }

        // Функция для сохранения списка включенных линий в куки
        function saveSelectedLinesToCookie(selectedLines) {
            document.cookie = `selectedLines=${JSON.stringify(selectedLines)}; expires=${new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toUTCString()}; path=/`;
        }

        // Функция для получения списка включенных линий из куки
        function getSelectedLinesFromCookie() {
            const cookies = document.cookie.split(';').map(cookie => cookie.trim());
            const selectedLinesCookie = cookies.find(cookie => cookie.startsWith('selectedLines='));
            if (selectedLinesCookie) {
                return JSON.parse(selectedLinesCookie.split('=')[1]);
            } else if (!selectedLinesCookie) {
                console.log('No cookies');
                createAllLines();
            }
            return [];
        }

        async function createAllLines() {
            const linesData = await fetchLinesData();
            const allLines = linesData.map(line => line.number); // Получаем массив всех номеров линий из API
            document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            createLineButtons()
            saveSelectedLinesToCookie(allLines);
        }

        async function addVehicleMarkers() {
            const vehicleData = await fetchVehicleData();
            let selectedLines = getSelectedLinesFromCookie();

            if (vehicleData) {
                // Очистка предыдущих маркеров с карты
                vehicleMarkers.clearLayers();

                vehicleData.forEach(vehicle => {

                    if (selectedLines.includes(vehicle.line_number)) {
                        var customIcon;
                        if (vehicle.vehicle_type === "bus") {
                            customIcon = L.divIcon({
                                className: 'bus-icon',
                                html: `<div>${vehicle.line_number}</div>`
                            });
                        } else if (vehicle.vehicle_type === "tram") {
                            customIcon = L.divIcon({
                                className: 'tram-icon',
                                html: `<div>${vehicle.line_number}</div>`
                            });
                        }

                        // Tworzenie znacznika z niestandardową ikoną dla każdego pojazdu
                        var marker = L.marker([vehicle.latitude, vehicle.longitude], {
                            icon: customIcon
                        }).addTo(vehicleMarkers);

                        marker.on('mouseover', function () {
                            drawLineTrajectory(vehicle.line_id);
                        });

                        marker.on('mouseout', function () {
                            removeLineTrajectory(vehicle.line_id);
                        });

                        // Dodawanie podpowiedzi do wyświetlania dodatkowych informacji
                        var nextStopInfo = vehicle.next_stop ? vehicle.next_stop : "Nieznane";
                        var directionInfo = vehicle.direction ? vehicle.direction : "Nieznane";
                        var puncInfo = vehicle.punctuality ? vehicle.punctuality : "Nieznane";
                        var velInfo = vehicle.velocity ? vehicle.velocity : "Nieznane";
                        var updateInfo = vehicle.updated_at ? new Date(vehicle.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "Nieznane";
                        marker.bindTooltip(
                            `Następny przystanek: ${nextStopInfo}
                    <br>
                    Kierunek: ${directionInfo}
                    <br>
                    Punktualność: ${puncInfo}
                    <br>
                    Prędkość: ${velInfo} km/h
                    <br>
                    Ostatnia aktualizacja: ${updateInfo}`
                        );
                    }
                });
            }
        }




        //------------------------------------------------------------------------------------------------------------------------------------
        // 2. Markers for bus stops
        //------------------------------------------------------------------------------------------------------------------------------------


        // Создание отдельного слоя для маркеров
        const busStopLayer = L.layerGroup().addTo(map);

        async function fetchBusStops() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/stops');
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Error fetching bus stops data:', error);
                return [];
            }
        }

        function renderVisibleBusStops(stopsData) {
            const mapBounds = map.getBounds();
            const zoomLevel = map.getZoom();
            const maxZoomToShowStops = 15; // Adjust this value as needed

            // Clear existing markers from the bus stop layer
            busStopLayer.clearLayers();

            if (zoomLevel <= maxZoomToShowStops) {
                // Do not display stops if zoom level is too high
                return;
            }

            stopsData.forEach(stop => {
                const stopLatLng = L.latLng(stop.latitude, stop.longitude);
                if (mapBounds.contains(stopLatLng)) {
                    const marker = L.marker(stopLatLng).addTo(busStopLayer);

                    marker.bindPopup(`
                <div>
                    <p>Numer przystanku: ${stop.number}</p>
                    <p>Na żądanie: ${stop.request_stop ? 'Tak' : 'Nie'}</p>
                    <p>Parking: ${stop.park_and_ride ? 'Tak' : 'Nie'}</p>
                    <button type="button" id="open_stop_modal" class="btn btn-primary" data-bs-toggle="modal" data-stop-number="${stop.number}" data-bs-target="#departureModal">Pokaż odjazdy</button>
                </div>`);
                }
            });
        }

        // При изменении масштаба карты вызываем функцию для отображения видимых остановок
        map.on('zoomend', () => {
            renderVisibleBusStops(busStopsData);
        });

        // Обновление видимых остановок при движении карты
        map.on('moveend', () => {
            renderVisibleBusStops(busStopsData);
        });

        // Инициализация процесса получения данных об остановках и отображения их на карте
        let busStopsData = [];
        fetchBusStops().then(data => {
            busStopsData = data;
            renderVisibleBusStops(busStopsData);
        }).catch(error => {
            console.error('Error fetching bus stops data:', error);
        });


        async function fetchAndPopulateDepartures(stopNumber) {
            try {
                const response = await fetch(`https://www.zditm.szczecin.pl/api/v1/displays/${stopNumber}`);
                const data = await response.json();

                // Set stop name in modal header
                document.getElementById('stopName').innerText = data.stop_name;

                // Clear previous table rows
                document.getElementById('departureTableBody').innerHTML = '';

                // Populate table with departures
                data.departures.forEach(departure => {
                    const realTime = departure.time_real !== null ? departure.time_real + ' min' : '';
                    const scheduledTime = departure.time_scheduled !== null ? departure.time_scheduled : '';

                    const row = `<tr>
                <td>${departure.line_number}</td>
                <td>${departure.direction}</td>
                <td>${realTime} ${scheduledTime}</td>
            </tr>`;

                    document.getElementById('departureTableBody').innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching and populating departures:', error);
            }
        }

        document.addEventListener('click', function (event) {
            // Sprawdź, czy kliknięty element to przycisk z atrybutem danych data-stop-number
            if (event.target.matches('[data-stop-number]')) {
                // Pobierz numer przystanku z atrybutu danych
                const stopNumber = event.target.getAttribute('data-stop-number');
                // Wywołaj funkcję, aby pobrać i wyświetlić odjazdy dla tego przystanku
                fetchAndPopulateDepartures(stopNumber);
            }
        });












        // Функция для получения данных о линиях
        async function fetchLinesData() {
            const response = await fetch('https://www.zditm.szczecin.pl/api/v1/lines');
            const data = await response.json();
            return data.data;
        }

        async function createLineButtons() {
            const linesData = await fetchLinesData();
            const selectedLines = getSelectedLinesFromCookie();
            document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            const accordionBody = document.querySelector('.accordion-body');

            const tramsContainer = document.createElement('div');

            const AccTitle = document.createElement('h2');
            AccTitle.textContent = 'Wybierz Wyświetlane Linie:';
            tramsContainer.appendChild(AccTitle);

            const br = document.createElement('br');
            tramsContainer.appendChild(br);

            // Фильтруем данные на трамваи и автобусы
            const tramsData = linesData.filter(line => line.vehicle_type === 'tram');
            const dayBusesData = linesData.filter(line => line.vehicle_type === 'bus' && line.type === 'day');
            const nightBusesData = linesData.filter(line => line.vehicle_type === 'bus' && line.type === 'night');

            // Создаем кнопки для трамваев
            tramsContainer.classList.add('mb-3'); // Добавляем отступ для разделения кнопок
            const tramsTitle = document.createElement('h5');
            tramsTitle.textContent = 'Tramwaje:';
            tramsContainer.appendChild(tramsTitle);
            tramsData.forEach(line => {
                const button = createButton(line, selectedLines);
                button.classList.add('me-1', 'me-md-2'); // Добавляем минимальные отступы справа и слева для всех кнопок линий
                button.setAttribute('id', `line_${line.number}`);
                tramsContainer.appendChild(button);
            });
            accordionBody.appendChild(tramsContainer);

            // Создаем кнопки для дневных автобусов
            const dayBusesContainer = document.createElement('div');

            const dayBusesTitle = document.createElement('h5');
            dayBusesTitle.textContent = 'Autobusy (Dzień):';
            dayBusesContainer.appendChild(dayBusesTitle);
            dayBusesData.forEach(line => {
                const button = createButton(line, selectedLines);
                button.classList.add('me-1', 'me-md-2'); // Добавляем минимальные отступы справа и слева для всех кнопок линий
                button.setAttribute('id', `line_${line.number}`);
                dayBusesContainer.appendChild(button);
            });

            accordionBody.appendChild(dayBusesContainer);

            // Создаем кнопки для ночных автобусов
            const nightBusesContainer = document.createElement('div');

            const nightBusesTitle = document.createElement('h5');
            nightBusesTitle.textContent = 'Autobusy (Noc):';
            nightBusesContainer.appendChild(nightBusesTitle);
            nightBusesData.forEach(line => {
                const button = createButton(line, selectedLines);
                button.classList.add('me-1', 'me-md-2'); // Добавляем минимальные отступы справа и слева для всех кнопок линий
                button.setAttribute('id', `line_${line.number}`);
                nightBusesContainer.appendChild(button);
            });

            accordionBody.appendChild(nightBusesContainer);

            const hr = document.createElement('hr');
            accordionBody.appendChild(hr);

            // Добавляем кнопку "Włącz wszystko"
            const enableAllButton = document.createElement('button');
            enableAllButton.classList.add('btn', 'btn-primary', 'mb-2', 'me-1', 'me-md-2'); // Добавляем минимальные отступы справа и слева для кнопки
            enableAllButton.textContent = 'Włącz Wszystko';
            enableAllButton.addEventListener('click', enableAllLines);
            accordionBody.appendChild(enableAllButton);

            // Добавляем кнопку "Wyłącz wszystko"
            const disableAllButton = document.createElement('button');
            disableAllButton.classList.add('btn', 'btn-primary', 'mb-2', 'ms-2'); // Добавляем класс "ms-2" для отступа слева
            disableAllButton.textContent = 'Wyłącz Wszystko';
            disableAllButton.addEventListener('click', disableAllLines);
            accordionBody.appendChild(disableAllButton);
        }



        // Создаем кнопку для линии
        function createButton(line, selectedLines) {
            const button = document.createElement('button');
            button.classList.add('btn', 'btn-primary', 'mb-2');
            button.textContent = `${line.number}`;
            button.addEventListener('click', () => toggleLine(line.number));
            if (selectedLines.includes(line.number)) {
                button.classList.add('btn-success'); // Подсвечиваем зеленым, если линия выбрана
            } else {
                button.classList.add('btn-danger'); // Подсвечиваем красным, если линия не выбрана
            }
            return button;
        }

        // Функция для включения всех линий
        async function enableAllLines() {
            const linesData = await fetchLinesData();
            const allLines = linesData.map(line => line.number); // Получаем массив всех номеров линий из API
            saveSelectedLinesToCookie(allLines);
            addVehicleMarkers();
            document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            createLineButtons()
        }
        // Функция для выключения всех линий
        function disableAllLines() {
            saveSelectedLinesToCookie([]);
            addVehicleMarkers();
            document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            createLineButtons()
        }

        // Добавляем или удаляем линию из списка включенных линий и сохраняем его в куки
        function toggleLine(lineNumber) {
            const selectedLines = getSelectedLinesFromCookie();
            if (selectedLines.includes(lineNumber)) {
                const index = selectedLines.indexOf(lineNumber);
                selectedLines.splice(index, 1);
            } else {
                selectedLines.push(lineNumber);
            }
            saveSelectedLinesToCookie(selectedLines);
            // Обновляем маркеры на карте
            addVehicleMarkers();

            if (document.getElementById(`line_${lineNumber}`).classList.contains('btn-danger')) {
                document.getElementById(`line_${lineNumber}`).classList.remove('btn-danger');
                document.getElementById(`line_${lineNumber}`).classList.add('btn-success');
            } else if (document.getElementById(`line_${lineNumber}`).classList.contains('btn-success')) {
                document.getElementById(`line_${lineNumber}`).classList.remove('btn-success');
                document.getElementById(`line_${lineNumber}`).classList.add('btn-danger');
            }


            // document.getElementById('collapseOne').innerHTML = '<div class="accordion-body"></div>';
            // createLineButtons()
        }

        // Вызываем функцию для создания кнопок при загрузке страницы
        document.addEventListener('DOMContentLoaded', async () => {
            await createLineButtons();
            addVehicleMarkers();
        });










        //-------------------------------------------------------------------------------------------------------------------------------------



        // Wywołaj funkcje do początkowego dodawania znaczników pojazdów
        addVehicleMarkers();

        // Utwórz grupę warstw dla znaczników pojazdów
        var vehicleMarkers = L.layerGroup().addTo(map);

        // Aktualizuj pozycje pojazdów co 10 sekund
        setInterval(addVehicleMarkers, speed);




        //-------------------------------------------------------------------------------------------------------------------------------------

        // Funkcja do pobierania danych z API dla linii
        async function fetchLinesData() {
            try {
                const response = await fetch('https://www.zditm.szczecin.pl/api/v1/lines');
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Błąd pobierania danych z API dotyczących linii:', error);
                return [];
            }
        }

        // Tworzenie warstwa dla trajektorii linii
        const lineTrajectoryLayer = L.layerGroup().addTo(map);

        // Funkcja do rysowania trasy linii na mapie
        function drawLineTrajectory(lineId) {
            console.log(`Drawing line ${lineId}`)
            fetch(`https://www.zditm.szczecin.pl/api/v1/trajectories/${lineId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Wystąpił błąd podczas pobierania danych.');
                    }
                    return response.json();
                })
                .then(data => {
                    const line = data.features.find(feature => feature.properties.route_variant_type === "default");
                    const coordinates = line.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    L.polyline(coordinates, { color: 'green' }).addTo(lineTrajectoryLayer);
                })
                .catch(error => {
                    console.error('Błąd pobierania danych z API dotyczących trajektorii:', error);
                    swal({
                        title: "Błąd Serwera",
                        text: `Błąd pobierania trajektorii dotyczących Linii`,
                        icon: "error",
                    });
                });
        }

        // Funkcja do usuwania trajektorii linii
        function removeLineTrajectory() {
            lineTrajectoryLayer.clearLayers(); // Usuwa wszystkie warstwy z warstwy linii trajektorii
        }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <style>
        .bus-icon {
            background-color: rgb(77, 77, 243);
            color: white;
            border-radius: 50%;
            padding: 12px;
            text-align: center;
            width: 30px;
            height: 30px;
            line-height: 15px;
            border: 1px solid black;
        }

        .tram-icon {
            background-color: rgb(184, 13, 184);
            color: white;
            border-radius: 50%;
            padding: 12px;
            text-align: center;
            width: 30px;
            height: 30px;
            line-height: 15px;
            border: 1px solid black;
        }

        .bus-icon,
        .tram-icon {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stop-icon {
            text-align: center;
            line-height: 30px;
        }
    </style>
</body>

</html>